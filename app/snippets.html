<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Snipee - ã‚¹ãƒ‹ãƒšãƒƒãƒˆå°‚ç”¨</title>
  <link rel="stylesheet" href="common/variables.css">
  <link rel="stylesheet" href="common/common.css">
  <script src="common/utils.js"></script>
  <style>
    /* snippets.html å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ */
    body {
      background: transparent;
      user-select: none;
    }

    .container {
      width: 210px;
      display: flex;
      flex-direction: column;
      -webkit-app-region: drag;
    }

    .content {
      width: 210px;
      -webkit-app-region: drag;
    }

    .section-header {
      letter-spacing: 0.5px;
    }

    .menu-item.selected {
      background: var(--primary-color);
      color: #ffffff;
    }

    .menu-item.selected .menu-item-text {
      color: #ffffff;
    }

    .menu-item-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .action-item {
      padding: 4px 11px;
      font-size: 12px;
      -webkit-app-region: no-drag;
    }

    .action-item.selected {
      background: var(--primary-color);
      color: #ffffff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="content" id="main-content">
      <div class="section" id="master-section">
        <div class="section-header">ğŸ“‹ ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>
        <div id="master-snippet-section"></div>
      </div>

      <div class="section" id="personal-section">
        <div class="section-header">âœ å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>
        <div id="personal-snippet-section"></div>
      </div>

      <div class="section">
        <div class="action-item" onclick="openSnippetEditor()">
          <span class="action-icon">âœ</span>
          <span>ã‚¹ãƒ‹ãƒšãƒƒãƒˆç·¨é›†</span>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="footer-row">
        <span><span class="key">â†‘â†“</span>é¸æŠ</span>
        <span><span class="key">â†’</span>å±•é–‹</span>
      </div>
      <div class="footer-row">
        <span><span class="key">â†</span>é–‰ã˜ã‚‹</span>
        <span><span class="key">Esc</span>çµ‚äº†</span>
      </div>
    </div>
  </div>

  <div class="submenu-overlay">
    <div class="submenu-container" id="inline-submenu"></div>
  </div>

  <script>
      const { ipcRenderer } = require('electron');
      const Store = require('electron-store');
      const store = new Store();

      let allItems = {
      personal: [],
      master: []
    };
    
    let nav; // KeyboardNavigator

    async function init() {
      setupEventListeners();  // navã‚’å…ˆã«åˆæœŸåŒ–
      await loadAllItems();
    }

    async function loadAllItems() {
      const data = await ipcRenderer.invoke('get-all-items');
      
      allItems.personal = (data.personalSnippets || []).map(s => ({ ...s, type: 'personal' }));
      allItems.master = (data.masterSnippets || []).map(s => ({ ...s, type: 'master' }));

      render();
    }

    function setupEventListeners() {
      // KeyboardNavigatoråˆæœŸåŒ–
      nav = new KeyboardNavigator({
        itemSelector: '.menu-item[data-folder], .action-item',
        onEscape: async () => {
          if (nav.isSubmenuOpen) {
            hideInlineSubmenu();
          } else {
            await ipcRenderer.invoke('hide-snippet-window');
          }
        },
        onEnter: (item) => {
          if (item?.classList.contains('action-item')) {
            item.click();
          } else {
            showSubmenuForSelectedItem();
          }
        },
        onRight: () => {
          const item = nav.getSelectedItem();
          if (item && !item.classList.contains('action-item')) {
            showSubmenuForSelectedItem();
          }
        },
        onLeft: () => hideInlineSubmenu(),
        onSubmenuEnter: (item) => pasteSubmenuItem(item.content),
        onSubmenuMove: () => nav.updateSubmenuVisual()
      });
      nav.attach();

      ipcRenderer.on('personal-snippets-updated', () => {
        loadAllItems();
      });
    }

    function render() {
      renderMasterSnippets();
      renderPersonalSnippets();
      updateSelectableItems();
    }

    function updateSelectableItems() {
      nav.updateItems('.menu-item[data-folder], .action-item');
    }
    
    function renderMasterSnippets() {
      const container = document.getElementById('master-snippet-section');
      const section = document.getElementById('master-section');
      let items = allItems.master;

      const hiddenFolders = store.get('hiddenFolders', []);
      items = items.filter(item => !hiddenFolders.includes(item.folder || 'æœªåˆ†é¡'));

      if (items.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      const folders = groupByFolder(items);
      
      container.innerHTML = Object.entries(folders).map(([folder, snippets]) => `
        <div class="menu-item" 
            data-folder="${folder}" 
            data-snippets='${JSON.stringify(snippets).replace(/'/g, "&apos;")}'>
          <div class="menu-item-left">
            <span class="menu-item-icon">ğŸ“</span>
            <span class="menu-item-text">${escapeHtml(folder)}</span>
          </div>
          <span class="menu-item-arrow">â€º</span>
        </div>
      `).join('');
    }

    function renderPersonalSnippets() {
      const container = document.getElementById('personal-snippet-section');
      const section = document.getElementById('personal-section');
      let items = allItems.personal;

      const hiddenFolders = store.get('hiddenFolders', []);
      items = items.filter(item => !hiddenFolders.includes(item.folder || 'æœªåˆ†é¡'));

      if (items.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      const folders = groupByFolder(items);
      
      container.innerHTML = Object.entries(folders).map(([folder, snippets]) => `
        <div class="menu-item" 
            data-folder="${folder}" 
            data-snippets='${JSON.stringify(snippets).replace(/'/g, "&apos;")}'>
          <div class="menu-item-left">
            <span class="menu-item-icon">ğŸ“</span>
            <span class="menu-item-text">${escapeHtml(folder)}</span>
          </div>
          <span class="menu-item-arrow">â€º</span>
        </div>
      `).join('');
    }

    function showSubmenuForSelectedItem() {
      const item = nav.getSelectedItem();
      if (!item) return;
      
      if (item.classList.contains('menu-item')) {
        let items = [];
        
        try {
          if (item.hasAttribute('data-folder')) {
            const rawData = item.getAttribute('data-snippets');
            items = JSON.parse(rawData);
          }
          
          if (items.length > 0) {
            showInlineSubmenu(item, items);
          }
        } catch (error) {
          // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
      }
    }

    function showInlineSubmenu(targetElement, items) {
      const submenu = document.getElementById('inline-submenu');
      const bounds = targetElement.getBoundingClientRect();
      
      const itemHeight = 22;
      const estimatedHeight = items.length * itemHeight;
      const viewportHeight = window.innerHeight;
      const margin = 10;
      
      // ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¸Šã®æ–¹ã‹ã‚‰è¡¨ç¤ºï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä¸Šç«¯ã‹ã‚‰å°‘ã—ä¸‹ï¼‰
      let top = margin;
      
      // å¸¸ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«è¨­å®šï¼ˆmaxHeightã§åˆ¶é™ï¼‰
      const maxHeight = viewportHeight - margin * 2;
      submenu.style.maxHeight = maxHeight + 'px';
      submenu.style.overflowY = 'auto';
      
      submenu.style.left = (bounds.right - 5) + 'px';
      submenu.style.top = top + 'px';
      
      nav.openSubmenu(items);

      submenu.innerHTML = items.map((item, index) => {
        const displayText = item.title || item.content || '';
        const truncatedText = displayText.length > 25 ? displayText.substring(0, 25) + '...' : displayText;
        
        return `
          <div class="submenu-item ${index === 0 ? 'selected' : ''}" data-index="${index}">
            <div class="submenu-item-title">ğŸ“„ ${index + 1}. ${escapeHtml(truncatedText)}</div>
          </div>
        `;
      }).join('');
      
      submenu.classList.add('visible');
  
      submenu.querySelectorAll('.submenu-item').forEach((element, index) => {
        element.addEventListener('click', async () => {
          await pasteSubmenuItem(items[index].content);
        });
      });
    }

    function hideInlineSubmenu() {
      const submenu = document.getElementById('inline-submenu');
      submenu.classList.remove('visible');
      nav.closeSubmenu();
    }

    async function pasteSubmenuItem(content) {
      const decodedContent = decodeHtmlEntities(content);
      
      hideInlineSubmenu();
      await ipcRenderer.invoke('hide-snippet-window');
      await ipcRenderer.invoke('paste-text', decodedContent);
    }

    async function openSnippetEditor() {
      await ipcRenderer.invoke('hide-snippet-window');
      await ipcRenderer.invoke('open-snippet-editor');
    }

    window.addEventListener('focus', () => {
      loadAllItems();
    });

    init();
  </script>
</body>
</html>