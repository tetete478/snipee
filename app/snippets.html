<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Snipee - ã‚¹ãƒ‹ãƒšãƒƒãƒˆå°‚ç”¨</title>
  <link rel="stylesheet" href="common/variables.css">
  <link rel="stylesheet" href="common/common.css">
  <script src="common/utils.js"></script>
  <script src="common/theme.js"></script>
  <style>
    /* snippets.html å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ */
    .action-item {
      padding: 4px 11px;
      font-size: 12px;
    }
  </style>
</head>
<body class="popup-window">
  <div class="container popup-container">
    <div class="content" id="main-content">
      <div class="section" id="master-section">
        <div class="section-header">ğŸ“‹ ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>
        <div id="master-snippet-section"></div>
      </div>

      <div class="section" id="personal-section">
        <div class="section-header">âœ å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>
        <div id="personal-snippet-section"></div>
      </div>

      <div class="section">
        <div class="action-item" onclick="openSnippetEditor()">
          <span class="action-icon">âœ</span>
          <span>ã‚¹ãƒ‹ãƒšãƒƒãƒˆç·¨é›†</span>
        </div>
      </div>
    </div>
  </div>

  <div class="submenu-overlay">
    <div class="submenu-container" id="inline-submenu"></div>
  </div>

  <script>
      const { ipcRenderer } = require('electron');
      const Store = require('electron-store');
      const store = new Store();

      let allItems = {
      personal: [],
      master: []
    };
    
    let nav; // KeyboardNavigator

    async function init() {
      setupEventListeners();  // navã‚’å…ˆã«åˆæœŸåŒ–
      await loadAllItems();
    }

    async function loadAllItems(sendReady = true) {
      const data = await ipcRenderer.invoke('get-all-items');
      
      allItems.personal = (data.personalSnippets || []).map(s => ({ ...s, type: 'personal' }));
      allItems.master = (data.masterSnippets || []).map(s => ({ ...s, type: 'master' }));

      render();
  
      // åˆå›ã®ã¿ãƒªã‚µã‚¤ã‚ºï¼ˆsendReady=trueã®æ™‚ã®ã¿ï¼‰
      if (sendReady) {
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const bodyRect = document.body.getBoundingClientRect();
        const actualWidth = Math.ceil(bodyRect.width);
        const actualHeight = Math.ceil(bodyRect.height);
        
        await ipcRenderer.invoke('resize-window', { width: actualWidth, height: actualHeight });
        
        ipcRenderer.send('window-ready');
      }
    }

    function setupEventListeners() {
      // KeyboardNavigatoråˆæœŸåŒ–
      nav = new KeyboardNavigator({
        itemSelector: '.menu-item[data-folder], .action-item',
        onFocusChange: (item) => {
          if (item && !item.classList.contains('action-item')) {
            showSubmenuForSelectedItem(false);  // è¡¨ç¤ºã®ã¿
          } else {
            hideInlineSubmenu();
          }
        },
        onEscape: async () => {
          if (nav.isSubmenuOpen) {
            hideInlineSubmenu();
          } else {
            await ipcRenderer.invoke('hide-snippet-window');
          }
        },
        onEnter: (item) => {
          if (item?.classList.contains('action-item')) {
            item.click();
          } else {
            showSubmenuForSelectedItem();
          }
        },
        onRight: () => {
          const item = nav.getSelectedItem();
          if (item && !item.classList.contains('action-item')) {
            showSubmenuForSelectedItem(true);  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚‚ç§»å‹•
          }
        },
        onLeft: () => hideInlineSubmenu(),
        onSubmenuEnter: (item) => pasteSubmenuItem(item.content),
        onSubmenuMove: () => nav.updateSubmenuVisual()
      });
      nav.attach();

      ipcRenderer.on('pre-load-data', async () => {
        await loadAllItems(false);
      });

      ipcRenderer.on('personal-snippets-updated', () => {
        loadAllItems(false);
      });
    }

    function render() {
      renderMasterSnippets();
      renderPersonalSnippets();
      updateSelectableItems();
    }
    
    function renderMasterSnippets() {
      const container = document.getElementById('master-snippet-section');
      const section = document.getElementById('master-section');
      let items = allItems.master;

      const hiddenFolders = store.get('hiddenFolders', []);
      items = items.filter(item => !hiddenFolders.includes(item.folder || 'æœªåˆ†é¡'));

      if (items.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      const folders = groupByFolder(items);
      
      container.innerHTML = Object.entries(folders).map(([folder, snippets]) => `
        <div class="menu-item" 
            data-folder="${folder}" 
            data-snippets='${JSON.stringify(snippets).replace(/'/g, "&apos;")}'>
          <div class="menu-item-left">
            <span class="menu-item-icon">ğŸ“</span>
            <span class="menu-item-text">${escapeHtml(folder)}</span>
          </div>
          <span class="menu-item-arrow">â€º</span>
        </div>
      `).join('');
    }

    function renderPersonalSnippets() {
      const container = document.getElementById('personal-snippet-section');
      const section = document.getElementById('personal-section');
      let items = allItems.personal;

      const hiddenFolders = store.get('hiddenFolders', []);
      items = items.filter(item => !hiddenFolders.includes(item.folder || 'æœªåˆ†é¡'));

      if (items.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      const folders = groupByFolder(items);
      
      container.innerHTML = Object.entries(folders).map(([folder, snippets]) => `
        <div class="menu-item" 
            data-folder="${folder}" 
            data-snippets='${JSON.stringify(snippets).replace(/'/g, "&apos;")}'>
          <div class="menu-item-left">
            <span class="menu-item-icon">ğŸ“</span>
            <span class="menu-item-text">${escapeHtml(folder)}</span>
          </div>
          <span class="menu-item-arrow">â€º</span>
        </div>
      `).join('');
    }

    function updateSelectableItems() {
      nav.updateItems('.menu-item[data-folder], .action-item');
      
      // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      nav.selectableItems.forEach((item, index) => {
        item.addEventListener('mouseenter', () => {
          nav.selectedIndex = index;
          nav.updateVisual();
          // ãƒ•ã‚©ãƒ«ãƒ€ãªã‚‰ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
          if (!item.classList.contains('action-item')) {
            showSubmenuForSelectedItem(false);
          } else {
            hideInlineSubmenu();
          }
        });
        
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          if (item.classList.contains('action-item')) {
            return;
          }
          showSubmenuForSelectedItem(true);
        });
      });
    }

    function showSubmenuForSelectedItem(focusSubmenu = true) {
      const item = nav.getSelectedItem();
      if (!item) return;
      
      if (item.classList.contains('menu-item')) {
        let items = [];
        
        try {
          if (item.hasAttribute('data-folder')) {
            const rawData = item.getAttribute('data-snippets');
            items = JSON.parse(rawData);
          }
          
          if (items.length > 0) {
            showInlineSubmenu(item, items, focusSubmenu);
          }
        } catch (error) {
          // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
      }
    }

    async function showInlineSubmenu(targetElement, items, focusSubmenu = true) {
      const submenu = document.getElementById('inline-submenu');
      const bounds = targetElement.getBoundingClientRect();
      
      // ã¾ãšæœ€å¤§ã‚µã‚¤ã‚ºã§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ‹¡å¤§
      await ipcRenderer.invoke('resize-window', { width: SUBMENU_CONFIG.maxWindowWidth, height: SUBMENU_CONFIG.maxWindowHeight });
      
      let top = SUBMENU_CONFIG.margin + SUBMENU_CONFIG.topOffset;
      
      const maxHeight = SUBMENU_CONFIG.maxWindowHeight - SUBMENU_CONFIG.margin * 2;
      submenu.style.maxHeight = maxHeight + 'px';
      submenu.style.overflowY = 'auto';
      
      submenu.style.left = (bounds.right - 5) + 'px';
      submenu.style.top = top + 'px';
      
      if (focusSubmenu) {
        nav.openSubmenu(items);
      }

      submenu.innerHTML = items.map((item, index) => {
        const displayText = item.title || item.content || '';
        const truncatedText = displayText.length > 25 ? displayText.substring(0, 25) + '...' : displayText;
        
        return `
          <div class="submenu-item ${focusSubmenu && index === 0 ? 'selected' : ''}" data-index="${index}">
            <div class="submenu-item-title">ğŸ“„ ${index + 1}. ${escapeHtml(truncatedText)}</div>
          </div>
        `;
      }).join('');
      
      submenu.classList.add('visible');

      submenu.querySelectorAll('.submenu-item').forEach((element, index) => {
        element.addEventListener('click', async () => {
          await pasteSubmenuItem(items[index].content);
        });
      });

      // ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºå¾Œã€å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ãƒªã‚µã‚¤ã‚º
      await new Promise(resolve => setTimeout(resolve, 50));

      const containerRect = document.querySelector('.container').getBoundingClientRect();
      const submenuRect = submenu.getBoundingClientRect();

      // å¹…: ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠå¹… + ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¹… + ã‚·ãƒ£ãƒ‰ã‚¦ç”¨ä½™ç™½
      const actualWidth = Math.ceil(containerRect.width + submenuRect.width + 15);
      // é«˜ã•: ä¸¡æ–¹ã®é«˜ã•ã®å¤§ãã„æ–¹ï¼ˆä½™è£•ã‚’æŒãŸã›ã¦+20pxï¼‰
      const actualHeight = Math.ceil(Math.max(containerRect.height, submenuRect.height + 20));

      await ipcRenderer.invoke('resize-window', { width: actualWidth, height: actualHeight });
    }

    async function hideInlineSubmenu() {
      const submenu = document.getElementById('inline-submenu');
      submenu.classList.remove('visible');
      nav.closeSubmenu();
      
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
      await new Promise(resolve => setTimeout(resolve, 50));
      
      // ãƒ›ãƒ¼ãƒ ç”»é¢ï¼ˆ.containerï¼‰ã®å¹…ã®ã¿ã‚’å–å¾—
      const containerRect = document.querySelector('.container').getBoundingClientRect();
      const actualWidth = Math.ceil(containerRect.width);
      const actualHeight = Math.ceil(containerRect.height);
      
      // å®Ÿéš›ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ãƒªã‚µã‚¤ã‚º
      await ipcRenderer.invoke('resize-window', { width: actualWidth, height: actualHeight });
    }

    async function pasteSubmenuItem(content) {
      const decodedContent = decodeHtmlEntities(content);
      
      hideInlineSubmenu();
      await ipcRenderer.invoke('hide-snippet-window');
      
      const result = await ipcRenderer.invoke('paste-text', decodedContent);
      
      if (!result.success && result.error !== 'permission_denied') {
        ipcRenderer.send('log', 'è‡ªå‹•ãƒšãƒ¼ã‚¹ãƒˆå¤±æ•—ã€ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼æ¸ˆã¿');
      }
    }

    async function openSnippetEditor() {
      await ipcRenderer.invoke('hide-snippet-window');
      await ipcRenderer.invoke('open-snippet-editor');
    }

    window.addEventListener('focus', () => {
      loadAllItems(false);
      nav.selectedIndex = 0;
      nav.updateVisual();
    });

    init();
  </script>
</body>
</html>