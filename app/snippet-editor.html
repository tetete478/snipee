<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ã‚¹ãƒ‹ãƒšãƒƒãƒˆç·¨é›† - Snipee</title>
  <link rel="stylesheet" href="common/variables.css">
  <link rel="stylesheet" href="common/common.css">
  <script src="common/utils.js"></script>
  <script src="common/drag-drop.js"></script>
  <style>
    /* snippet-editor.html å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ */
    body {
      background: #ffffff;
      color: #1d1d1f;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .section-header {
      padding: 12px 12px 6px 12px;
      font-size: var(--font-size-small);
      font-weight: 600;
      color: #86868b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: #f5f5f7;
      border-bottom: 1px solid #e5e5ea;
      user-select: none;
      cursor: default;
    }

    .toolbar {
      background: #ffffff;
      border-bottom: 1px solid #d2d2d7;
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      align-items: center;
      -webkit-app-region: drag;
    }

    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: transparent;
      border: 1px solid #d2d2d7;
      border-radius: 6px;
      cursor: pointer;
      font-size: var(--font-size-normal);
      color: #1d1d1f;
      transition: all 0.2s ease;
      font-weight: 400;
      -webkit-app-region: no-drag;
    }

    .toolbar-btn:hover {
      background: #f5f5f7;
      border-color: #86868b;
    }

    .toolbar-btn:active {
      background: #e8e8ed;
      transform: scale(0.98);
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      width: 240px;
      background: #f5f5f7;
      border-right: 1px solid #d2d2d7;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .folder-group {
      border-bottom: 1px solid #e5e5ea;
      box-sizing: border-box;
    }

    .folder-group.drag-over-bottom {
      border-bottom: 2px solid var(--primary-color);
    }

    .folder-header {
      padding: 4px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: var(--font-size-normal);
      font-weight: 500;
      user-select: none;
      transition: background 0.15s ease;
      color: #1d1d1f;
      line-height: 1.2;
      border-top: 2px solid transparent;
    }

    .folder-header:hover {
      background: #e8e8ed;
    }

    .folder-header.selected {
      background: var(--primary-color);
      color: #ffffff;
    }

    .folder-toggle {
      font-size: 10px;
      width: 12px;
      transition: transform 0.2s ease;
      color: #86868b;
      cursor: pointer;
      user-select: none;
    }

    .folder-header.selected .folder-toggle {
      color: rgba(255,255,255,0.8);
    }

    .folder-toggle.expanded {
      transform: rotate(90deg);
    }

    .folder-icon {
      font-size: var(--font-size-medium);
      opacity: 0.8;
      cursor: pointer;
      user-select: none;
    }

    .folder-name {
      flex: 1;
      font-weight: 500;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }

    .snippet-list {
      display: none;
      background: rgba(0,0,0,0.02);
      border-bottom: 2px solid transparent;
    }

    .snippet-list.expanded {
      display: block;
    }

    .snippet-list.drag-over-bottom {
      border-bottom-color: var(--primary-color);
    }

    .snippet-item {
      padding: 3px 12px 3px 32px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      transition: background 0.15s ease;
      color: #1d1d1f;
      user-select: none;
      line-height: 1.2;
      border-top: 2px solid transparent;
    }

    .snippet-item:hover {
      background: #e8e8ed;
    }

    .snippet-item.selected {
      background: #d0d0d5;
      color: #1d1d1f;
    }

    .snippet-icon {
      font-size: 12px;
      opacity: 0.6;
      cursor: pointer;
      user-select: none;
    }

    .snippet-item.selected .snippet-icon {
      opacity: 0.9;
    }

    .snippet-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 400;
      font-size: var(--font-size-small);
      cursor: pointer;
      user-select: none;
    }

    .snippet-badge {
      font-size: 9px;
      padding: 1px 4px;
      background: #34c759;
      color: white;
      border-radius: 3px;
      margin-left: 4px;
      user-select: none;
      pointer-events: none;
    }

    .snippet-item.selected .snippet-badge {
      background: rgba(255,255,255,0.3);
    }

    .content-panel {
      flex: 1;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .editor-area {
      flex: 1;
      padding: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .editor-empty {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100%;
      color: #86868b;
      font-size: var(--font-size-medium);
    }

    .editor-empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.15;
    }

    .form-textarea {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-family: var(--font-family);
      resize: none;
      line-height: 1.3;
      background: #ffffff;
      color: #1d1d1f;
    }

    .form-textarea:focus {
      outline: none;
    }

    .form-textarea:read-only {
      background: #f5f5f7;
      color: #86868b;
      cursor: not-allowed;
    }

    .editor-header {
      padding: 12px;
      border-bottom: 1px solid #e5e5ea;
      display: flex;
      align-items: center;
      gap: 8px;
      background: #fafafa;
    }

    .editor-title {
      font-size: var(--font-size-large);
      font-weight: 600;
      color: #1d1d1f;
    }

    .master-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: #34c759;
      color: white;
      border-radius: 3px;
    }

    .readonly-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: #ff9500;
      color: white;
      border-radius: 3px;
    }

    .dragging {
      opacity: 0.5;
      background: rgba(0, 122, 255, 0.15) !important;
      transition: opacity 0.15s ease;
    }

    .drag-over {
      border-top-color: var(--primary-color) !important;
    }

    .editor-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      gap: 0;
    }

    .main-editor {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #d2d2d7;
      position: relative;
    }

    .description-panel {
      width: 190px;
      background: #fafafa;
      display: flex;
      flex-direction: column;
      padding: 0;
      transition: width 0.2s ease;
      position: relative;
    }

    .description-panel.collapsed {
      width: 0;
      overflow: hidden;
      border-left: none;
    }

    .description-toggle {
      position: absolute;
      top: 50%;
      right: -8px;
      transform: translateY(-50%);
      background: #ffffff;
      border: 1px solid #d2d2d7;
      border-radius: 3px;
      cursor: pointer;
      font-size: 8px;
      color: #86868b;
      padding: 4px 2px;
      transition: all 0.2s ease;
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      width: 16px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .description-toggle:hover {
      color: var(--primary-color);
      border-color: var(--primary-color);
      background: #f8f9fa;
    }

    .description-toggle:active {
      transform: translateY(-50%) scale(0.95);
    }

    .description-textarea {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 0;
      font-size: 12px;
      font-family: var(--font-family);
      resize: none;
      line-height: 1.3;
      background: #fafafa;
      color: #1d1d1f;
    }

    .description-panel.collapsed .description-textarea {
      display: none;
    }

    .description-textarea:focus {
      outline: none;
    }

    .folder-badge {
      font-size: 8px;
      padding: 1px 4px;
      background: #ff6b6b;
      color: white;
      border-radius: 2px;
      margin-left: 6px;
      user-select: none;
      pointer-events: none;
      font-weight: 500;
      opacity: 0.85;
    }

    .folder-badge.personal {
      background: #5a9fd4;
      opacity: 0.85;
    }

    .folder-header.selected .folder-badge {
      background: rgba(255,255,255,0.3);
      opacity: 1;
    }

    .folder-toggle-area {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      margin-left: -12px;
      padding-left: 12px;
    }

    .pane-focused {
      box-shadow: 0 0 0 2px var(--primary-color);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <button class="toolbar-btn" onclick="addFolder()" title="ãƒ•ã‚©ãƒ«ãƒ€è¿½åŠ ">
        <span>ğŸ“+</span>
      </button>
      <button class="toolbar-btn" onclick="addSnippet()" title="ã‚¹ãƒ‹ãƒšãƒƒãƒˆè¿½åŠ ">
        <span>ğŸ“„+</span>
      </button>
      <button class="toolbar-btn" onclick="deleteSelected()" title="å‰Šé™¤">
        <span>ğŸ—‘</span>
      </button>
      <button class="toolbar-btn" onclick="showExportDialog()" title="XMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ">
        <span>ğŸ“¤ Export</span>
      </button>
      <button class="toolbar-btn" onclick="showMasterPasswordDialog()" id="master-edit-btn" style="display: none;" title="ãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰">
        <span>ğŸ”’ ç·¨é›†</span>
      </button>
    </div>

    <div class="main-content">
      <div class="sidebar" id="sidebar"></div>
      <div class="content-panel">
        <div class="editor-area" id="editor-area">
          <div class="editor-empty">
            <div class="editor-empty-icon">ğŸ“</div>
            <div>ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="export-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 24px; border-radius: 12px; width: 360px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 16px 0; font-size: 16px;">XMLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
      <p style="margin: 0 0 16px 0; font-size: 13px; color: #666;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š</p>
      
      <div style="margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: 600; padding: 8px; background: #f5f5f7; border-radius: 6px;">
          <input type="checkbox" id="export-select-all" onchange="toggleSelectAll()">
          <span>ã™ã¹ã¦é¸æŠ</span>
        </label>
      </div>
      
      <div id="export-folder-list" style="display: flex; flex-direction: column; gap: 4px; margin-bottom: 20px;">
        <!-- ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
      </div>
      
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button onclick="hideExportDialog()" style="padding: 8px 16px; border: 1px solid #d2d2d7; background: white; border-radius: 6px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="executeExport()" style="padding: 8px 16px; border: none; background: #007aff; color: white; border-radius: 6px; cursor: pointer;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- ãƒã‚¹ã‚¿ç·¨é›†ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <div id="master-password-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 24px; border-radius: 12px; width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 style="margin: 0 0 16px 0; font-size: 16px;">ğŸ” ãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</h3>
      <p style="margin: 0 0 16px 0; font-size: 13px; color: #666;">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</p>
      <input type="password" id="master-password-input" style="width: 100%; padding: 10px; border: 1px solid #d2d2d7; border-radius: 6px; font-size: 14px; box-sizing: border-box; margin-bottom: 16px;" onkeydown="if(event.key==='Enter'){verifyMasterPassword();}">
      <div id="master-password-error" style="color: #ff3b30; font-size: 12px; margin-bottom: 12px; display: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
      <div style="display: flex; gap: 8px; justify-content: flex-end;">
        <button onclick="hideMasterPasswordDialog()" style="padding: 8px 16px; border: 1px solid #d2d2d7; background: white; border-radius: 6px; cursor: pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="verifyMasterPassword()" style="padding: 8px 16px; border: none; background: #007aff; color: white; border-radius: 6px; cursor: pointer;">è§£é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let isDescriptionOpen = true;

    let folders = [];
    let masterSnippets = [];
    let masterFolders = [];  // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆç‹¬ç«‹ç®¡ç†ï¼‰
    let personalSnippets = [];
    let allSnippets = [];
    let currentPane = 'sidebar'; // 'sidebar' | 'content' | 'description'
    let expandedFolders = new Set();
    let selectedFolder = null;
    let selectedSnippet = null;
    let isMasterEditMode = false;  // ãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰

    async function init() {
      await loadData();
      render();
      updateMasterEditButton();
    }

    async function loadData() {
      const personalData = await ipcRenderer.invoke('get-personal-snippets');
      folders = personalData.folders || [];
      personalSnippets = personalData.snippets || [];
      
      const allData = await ipcRenderer.invoke('get-all-items');
      masterSnippets = allData.masterSnippets || [];
      
      const masterOrder = await ipcRenderer.invoke('get-master-order');
      if (masterOrder.length > 0) {
        const orderMap = new Map(masterOrder.map((item, index) => [item.id, index]));
        
        masterSnippets.sort((a, b) => {
          const orderA = orderMap.has(a.id) ? orderMap.get(a.id) : 999999;
          const orderB = orderMap.has(b.id) ? orderMap.get(b.id) : 999999;
          return orderA - orderB;
        });
      }
      
      masterFolders = await ipcRenderer.invoke('get-master-folders');
      masterSnippets = masterSnippets.map(s => ({ ...s, isMaster: true }));
      
      allSnippets = [...masterSnippets, ...personalSnippets];
      updateMasterEditButton();
    }

    function render() {
      renderSidebar();
    }

    function renderSidebar() {
      const sidebar = document.getElementById('sidebar');
      
      // âœ… ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆç‹¬ç«‹ç®¡ç†ï¼‰ + ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‹ã‚‰å–å¾—ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’çµåˆ
      const allMasterFolders = [...new Set([...masterFolders, ...masterSnippets.map(s => s.folder)])];
      
      // âœ… å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®ãƒ•ã‚©ãƒ«ãƒ€ã ã‘ã‚’ä½¿ã†
      const personalFolders = folders;
      
      const masterSection = allMasterFolders.length > 0 ? `
        <div class="section-header">ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>
        ${allMasterFolders.map(folder => {
          const folderSnippets = masterSnippets.filter(s => s.folder === folder);
          const isExpanded = expandedFolders.has(folder);
          const isSelected = selectedFolder === folder;
          
          return `
            <div class="folder-group">
              <div class="folder-header ${isSelected && !selectedSnippet ? 'selected' : ''}" data-is-master="true" data-folder="${escapeAttr(folder)}">
                <div class="folder-toggle-area" onclick="toggleFolder('${escapeAttr(folder)}')">
                  <span class="folder-toggle ${isExpanded ? 'expanded' : ''}">â–¶</span>
                  <span class="folder-icon">ğŸ“</span>
                </div>
                <span class="folder-name" onclick="toggleFolder('${escapeAttr(folder)}')" title="${escapeAttr(folder)}">${escapeHtml(folder)}</span>
                <span class="folder-badge">ãƒã‚¹ã‚¿</span>
              </div>
              <div class="snippet-list ${isExpanded ? 'expanded' : ''}">
                ${folderSnippets.map(snippet => `
                  <div class="snippet-item ${selectedSnippet?.id === snippet.id ? 'selected' : ''}" 
                    data-id="${snippet.id}"
                    data-folder="${escapeAttr(folder)}"
                    data-is-master="true"
                    onclick="selectSnippet('${snippet.id}')">
                    <span class="snippet-icon">ğŸ”’</span>
                    <span class="snippet-name" title="${escapeAttr(snippet.title || 'ç„¡é¡Œ')}">${escapeHtml(snippet.title || 'ç„¡é¡Œ')}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('')}
      ` : '';
      
      const personalSection = personalFolders.length > 0 ? `
        <div class="section-header">å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>
        ${personalFolders.map(folder => {
          const folderSnippets = personalSnippets.filter(s => s.folder === folder);
          const isExpanded = expandedFolders.has(folder);
          const isSelected = selectedFolder === folder;
          
          return `
            <div class="folder-group">
              <div class="folder-header ${isSelected && !selectedSnippet ? 'selected' : ''}" data-is-master="false" data-folder="${escapeAttr(folder)}">
                <div class="folder-toggle-area" onclick="toggleFolder('${escapeAttr(folder)}')">
                  <span class="folder-toggle ${isExpanded ? 'expanded' : ''}">â–¶</span>
                  <span class="folder-icon">ğŸ“</span>
                </div>
                <span class="folder-name" ondblclick="event.preventDefault(); startRenameFolder('${escapeAttr(folder)}')" title="${escapeAttr(folder)}">${escapeHtml(folder)}</span>
                <span class="folder-badge personal">å€‹åˆ¥</span>
              </div>
              <div class="snippet-list ${isExpanded ? 'expanded' : ''}">
                ${folderSnippets.map(snippet => `
                  <div class="snippet-item ${selectedSnippet?.id === snippet.id ? 'selected' : ''}" 
                    data-id="${snippet.id}"
                    data-folder="${escapeAttr(folder)}"
                    data-is-master="false"
                    onclick="selectSnippet('${snippet.id}')"
                    ondblclick="event.preventDefault(); startRenameSnippet('${snippet.id}')">
                    <span class="snippet-icon">ğŸ“„</span>
                    <span class="snippet-name" title="${escapeAttr(snippet.title || 'ç„¡é¡Œ')}">${escapeHtml(snippet.title || 'ç„¡é¡Œ')}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('')}
      ` : '';
      
      sidebar.innerHTML = masterSection + personalSection;

      initDragAndDrop();
    }

    function toggleFolder(folderName) {
      if (expandedFolders.has(folderName)) {
        expandedFolders.delete(folderName);
      } else {
        expandedFolders.add(folderName);
      }
      render();
    }

    function selectFolder(folderName) {
      selectedFolder = folderName;
      selectedSnippet = null;
      currentPane = 'sidebar';
      render();
      showEmpty();
    }

    function selectSnippet(snippetId) {
      selectedSnippet = allSnippets.find(s => s.id === snippetId);
      selectedFolder = null;
      currentPane = 'sidebar';
      render();
      showEditor();
    }

    function showEmpty() {
      const editor = document.getElementById('editor-area');
      editor.innerHTML = `
        <div class="editor-empty">
          <div class="editor-empty-icon">ğŸ“</div>
          <div>ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
      `;
    }

    function showEditor() {
      if (!selectedSnippet) {
        showEmpty();
        return;
      }

      const isMaster = selectedSnippet.isMaster === true;
      const canEdit = !isMaster || isMasterEditMode;
      const readonlyAttr = canEdit ? '' : 'readonly';
      
      const editor = document.getElementById('editor-area');
      editor.innerHTML = `
        ${isMaster ? `
        <div class="editor-header">
          <span class="editor-title">${escapeHtml(selectedSnippet.title || 'ç„¡é¡Œ')}</span>
          <span class="master-badge">ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</span>
          ${canEdit ? '<span class="readonly-badge" style="background: #34c759;">ç·¨é›†å¯èƒ½</span>' : '<span class="readonly-badge">å†…å®¹: èª­ã¿å–ã‚Šå°‚ç”¨</span>'}
        </div>
        ` : ''}
        <div class="editor-container">
          <div class="main-editor">
            <textarea class="form-textarea" id="snippet-content" ${readonlyAttr} ${canEdit ? 'oninput="autoSave()"' : ''} onkeydown="event.stopPropagation()">${escapeHtml(selectedSnippet.content || '')}</textarea>
            <button class="description-toggle" onclick="toggleDescription()">
              ${isDescriptionOpen ? 'â–¶' : 'â—€'}
            </button>
          </div>
          <div class="description-panel ${isDescriptionOpen ? '' : 'collapsed'}">
            <textarea class="description-textarea" id="snippet-description" oninput="autoSaveDescription()" onkeydown="event.stopPropagation()" placeholder="ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®èª¬æ˜ã‚’å…¥åŠ›...ï¼ˆå€‹äººç”¨ãƒ¡ãƒ¢ï¼‰">${escapeHtml(selectedSnippet.description || '')}</textarea>
          </div>
        </div>
      `;
    }

    function toggleDescription() {
      isDescriptionOpen = !isDescriptionOpen;
      showEditor();
    }

    function focusPane(pane) {
      currentPane = pane;
      
      // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.pane-focused').forEach(el => el.classList.remove('pane-focused'));
      document.getElementById('title-input')?.blur();
      document.getElementById('snippet-content')?.blur();
      document.getElementById('snippet-description')?.blur();
      
      if (pane === 'content') {
        const textarea = document.getElementById('snippet-content');
        if (textarea) {
          textarea.focus();
          textarea.classList.add('pane-focused');
        }
      } else if (pane === 'description') {
        const textarea = document.getElementById('snippet-description');
        if (textarea) {
          textarea.focus();
          textarea.classList.add('pane-focused');
        }
      }
      // sidebarã®å ´åˆã¯ä½•ã‚‚ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãªã„
    }

    async function autoSave() {
      if (!selectedSnippet) return;
      if (selectedSnippet.isMaster && !isMasterEditMode) return;
      
      selectedSnippet.content = document.getElementById('snippet-content')?.value || '';
      
      if (selectedSnippet.isMaster) {
        // ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®ä¿å­˜
        await ipcRenderer.invoke('update-master-snippet', selectedSnippet);
      } else {
        // å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®ä¿å­˜
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      }
    }

    async function autoSaveDescription() {
      if (!selectedSnippet) return;
      
      const description = document.getElementById('snippet-description')?.value || '';
      selectedSnippet.description = description;
      
      if (selectedSnippet.isMaster) {
        await ipcRenderer.invoke('update-master-description', selectedSnippet.id, description);
        await loadData();
      } else {
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      }
    }

    async function addFolder() {
      const newFolderName = 'æ–°ã—ã„ãƒ•ã‚©ãƒ«ãƒ€';
      let folderName = newFolderName;
      let counter = 1;
      
      // ãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã«è¿½åŠ 
      if (isMasterEditMode) {
        const allMasterFolders = [...new Set([...masterFolders, ...masterSnippets.map(s => s.folder)])];
        while (allMasterFolders.includes(folderName) || folders.includes(folderName)) {
          folderName = `${newFolderName} ${counter}`;
          counter++;
        }
        
        // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ãƒªã‚¹ãƒˆã«è¿½åŠ ï¼ˆã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯ä½œã‚‰ãªã„ï¼‰
        masterFolders.push(folderName);
        await ipcRenderer.invoke('save-master-folders', masterFolders);
        expandedFolders.add(folderName);
        selectedFolder = folderName;
        await loadData();
        render();
      } else {
        while (folders.includes(folderName)) {
          folderName = `${newFolderName} ${counter}`;
          counter++;
        }

        folders.push(folderName);
        expandedFolders.add(folderName);
        await ipcRenderer.invoke('save-personal-folders', folders);
        selectedFolder = folderName;
        render();
        setTimeout(() => startRenameFolder(folderName), 100);
      }
    }

    async function deleteFolder(folderName) {
      // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã‹ã©ã†ã‹åˆ¤å®š
      const allMasterFolders = [...new Set([...masterFolders, ...masterSnippets.map(s => s.folder)])];
      const isMasterFolder = allMasterFolders.includes(folderName);
      
      if (isMasterFolder && !isMasterEditMode) {
        alert('ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã¯å‰Šé™¤ã§ãã¾ã›ã‚“\nï¼ˆãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§å‰Šé™¤ã§ãã¾ã™ï¼‰');
        return;
      }
      
      if (isMasterFolder) {
        // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã®å‰Šé™¤
        const folderSnippets = masterSnippets.filter(s => s.folder === folderName);
        const message = `ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folderName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆ${folderSnippets.length}å€‹ã®ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`;
        
        if (!confirm(message)) return;
        
        // ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å…¨ã¦å‰Šé™¤
        for (const snippet of folderSnippets) {
          await ipcRenderer.invoke('delete-master-snippet', snippet.id);
        }
        
        // masterFoldersã‹ã‚‰ã‚‚å‰Šé™¤ï¼ˆç©ºãƒ•ã‚©ãƒ«ãƒ€å¯¾å¿œï¼‰
        masterFolders = masterFolders.filter(f => f !== folderName);
        await ipcRenderer.invoke('save-master-folders', masterFolders);
      } else {
        // å€‹åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ã®å‰Šé™¤
        const folderSnippets = personalSnippets.filter(s => s.folder === folderName);
        const message = folderSnippets.length > 0 
          ? `ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folderName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆ${folderSnippets.length}å€‹ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ï¼‰`
          : `ãƒ•ã‚©ãƒ«ãƒ€ã€Œ${folderName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
        
        if (!confirm(message)) return;

        folders = folders.filter(f => f !== folderName);
        personalSnippets = personalSnippets.filter(s => s.folder !== folderName);

        await ipcRenderer.invoke('save-personal-folders', folders);
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      }

      selectedFolder = null;
      await loadData();
      render();
      showEmpty();
    }

    async function addSnippet() {
      const targetFolder = selectedFolder || selectedSnippet?.folder || folders[0];
      
      if (!targetFolder) {
        alert('å…ˆã«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ãã ã•ã„');
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ãŒãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã‹ã©ã†ã‹åˆ¤å®šï¼ˆç©ºãƒ•ã‚©ãƒ«ãƒ€ã‚‚å«ã‚€ï¼‰
      const allMasterFolders = [...new Set([...masterFolders, ...masterSnippets.map(s => s.folder)])];
      const isTargetMasterFolder = allMasterFolders.includes(targetFolder);
      
      // ãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
      if (isMasterEditMode && isTargetMasterFolder) {
        const newSnippet = {
          id: Date.now().toString(),
          title: 'æ–°ã—ã„ã‚¹ãƒ‹ãƒšãƒƒãƒˆ',
          content: '',
          description: '',
          folder: targetFolder
        };
        
        await ipcRenderer.invoke('save-master-snippet', newSnippet);
        
        selectedSnippet = { ...newSnippet, isMaster: true };
        selectedFolder = null;
        expandedFolders.add(targetFolder);
        await loadData();
        render();
        showEditor();
      } else {
        // å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¨ã—ã¦è¿½åŠ 
        // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯è¿½åŠ ã•ã›ãªã„
        if (isTargetMasterFolder) {
          alert('ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ã«ã¯å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’è¿½åŠ ã§ãã¾ã›ã‚“\nï¼ˆãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰');
          return;
        }
        
        const newSnippet = {
          id: Date.now().toString(),
          title: 'æ–°ã—ã„ã‚¹ãƒ‹ãƒšãƒƒãƒˆ',
          content: '',
          description: '', 
          folder: targetFolder,
          isMaster: false
        };

        personalSnippets.push(newSnippet);
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);

        selectedSnippet = newSnippet;
        selectedFolder = null;
        expandedFolders.add(targetFolder);
        await loadData();
        render();
        showEditor();
      }
    }

    async function deleteSnippet(snippetId) {
      const snippet = allSnippets.find(s => s.id === snippetId);
      
      if (snippet.isMaster && !isMasterEditMode) {
        alert('ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“\nï¼ˆãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§å‰Šé™¤ã§ãã¾ã™ï¼‰');
        return;
      }
      
      if (!confirm('ã“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      if (snippet.isMaster) {
        // ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å‰Šé™¤
        await ipcRenderer.invoke('delete-master-snippet', snippetId);
      } else {
        // å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å‰Šé™¤
        personalSnippets = personalSnippets.filter(s => s.id !== snippetId);
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      }

      if (selectedSnippet?.id === snippetId) {
        selectedSnippet = null;
        showEmpty();
      }

      await loadData();
      render();
    }

    async function deleteSelected() {
      if (selectedSnippet) {
        await deleteSnippet(selectedSnippet.id);
      } else if (selectedFolder) {
        await deleteFolder(selectedFolder);
      } else {
        alert('å‰Šé™¤ã™ã‚‹é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
    }

    function handleEditorKeydown(e) {
      // content
      if (currentPane === 'content') {
        if (e.key === 'ArrowLeft' && !e.shiftKey) {
          const textarea = document.getElementById('snippet-content');
          // ã‚«ãƒ¼ã‚½ãƒ«ãŒå…ˆé ­ã®å ´åˆã®ã¿sidebarã¸
          if (textarea && textarea.selectionStart === 0 && textarea.selectionEnd === 0) {
            e.preventDefault();
            focusPane('sidebar');
          }
        } else if (e.key === 'ArrowRight' && !e.shiftKey) {
          const textarea = document.getElementById('snippet-content');
          // ã‚«ãƒ¼ã‚½ãƒ«ãŒæœ«å°¾ã®å ´åˆã®ã¿descriptionã¸
          if (textarea && textarea.selectionStart === textarea.value.length) {
            e.preventDefault();
            focusPane('description');
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          focusPane('sidebar');
        }
        return;
      }
      
      // description
      if (currentPane === 'description') {
        if (e.key === 'ArrowLeft' && !e.shiftKey) {
          const textarea = document.getElementById('snippet-description');
          // ã‚«ãƒ¼ã‚½ãƒ«ãŒå…ˆé ­ã®å ´åˆã®ã¿contentã¸
          if (textarea && textarea.selectionStart === 0 && textarea.selectionEnd === 0) {
            e.preventDefault();
            focusPane('content');
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          focusPane('sidebar');
        }
        return;
      }
    }

    function startRenameSnippet(snippetId) {
      const snippet = allSnippets.find(s => s.id === snippetId);
      if (snippet.isMaster) {
        alert('ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®åå‰ã¯å¤‰æ›´ã§ãã¾ã›ã‚“');
        return;
      }
      
      const snippetItem = document.querySelector(`.snippet-item[data-id="${snippetId}"]`);
      if (!snippetItem) return;
      
      const nameSpan = snippetItem.querySelector('.snippet-name');
      if (!snippet) return;
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = snippet.title || 'ç„¡é¡Œ';
      input.style.cssText = 'flex: 1; min-width: 0; width: 0; max-width: 100%; background: white; border: 1px solid #007aff; padding: 2px 4px; font-size: 12px; border-radius: 4px; box-sizing: border-box;';
      
      nameSpan.replaceWith(input);
      input.focus();
      input.select();
      
      let isFinishing = false;

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          e.stopPropagation();
          if (!isFinishing) {
            isFinishing = true;
            await finishRenameSnippet(snippetId, input.value);
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          e.stopPropagation();
          isFinishing = true;
          render();
        }
      });

      input.addEventListener('blur', async () => {
        if (!isFinishing) {
          isFinishing = true;
          await finishRenameSnippet(snippetId, input.value);
        }
      });
    }

    async function finishRenameSnippet(snippetId, newName) {
      const snippet = personalSnippets.find(s => s.id === snippetId);
      if (!snippet) return;
      
      const trimmedName = newName.trim();
      if (trimmedName) {
        snippet.title = trimmedName;
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      }
      
      await loadData();
      render();
      if (selectedSnippet?.id === snippetId) {
        showEditor();
      }

      moveToNextItem();
    }

    function startRenameFolder(folderName) {
      const escapedName = folderName.replace(/"/g, '\\"');
      const folderHeader = document.querySelector(`.folder-header[data-is-master="false"][data-folder="${escapedName}"]`);
      
      if (!folderHeader) return;
      
      const nameSpan = folderHeader.querySelector('.folder-name');
      if (!nameSpan) return;
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = folderName;
      input.style.cssText = 'flex: 1; min-width: 0; width: 0; max-width: 100%; background: white; border: 1px solid #007aff; padding: 2px 4px; font-size: 12px; border-radius: 4px; box-sizing: border-box;';
      
      nameSpan.replaceWith(input);
      input.focus();
      input.select();
      
      let isFinishing = false;

      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          e.stopPropagation();
          if (!isFinishing) {
            isFinishing = true;
            await finishRenameFolder(folderName, input.value);
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          e.stopPropagation();
          isFinishing = true;
          render();
        }
      });
      
      input.addEventListener('blur', async () => {
        if (!isFinishing) {
          isFinishing = true;
          await finishRenameFolder(folderName, input.value);
        }
      });
    }

    async function finishRenameFolder(oldName, newName) {
      const trimmedName = newName.trim();
      
      if (!trimmedName || trimmedName === oldName) {
        render();
        return;
      }
      
      const otherFolders = folders.filter(f => f !== oldName);
      
      if (otherFolders.includes(trimmedName)) {
        alert('ã“ã®ãƒ•ã‚©ãƒ«ãƒ€åã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        render();
        return;
      }
      
      const index = folders.indexOf(oldName);
      if (index !== -1) {
        folders[index] = trimmedName;
      }
      
      personalSnippets = personalSnippets.map(s => 
        s.folder === oldName ? {...s, folder: trimmedName} : s
      );
      
      if (expandedFolders.has(oldName)) {
        expandedFolders.delete(oldName);
        expandedFolders.add(trimmedName);
      }
      
      if (selectedFolder === oldName) {
        selectedFolder = trimmedName;
      }
      
      await ipcRenderer.invoke('save-personal-folders', folders);
      await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      
      await loadData();
      render();
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
    let dragDropManager = null;

    function initDragAndDrop() {
      if (!dragDropManager) {
        dragDropManager = new DragDropManager({
          container: '#sidebar',
          folderSelector: '.folder-header',
          itemSelector: '.snippet-item',
          listSelector: '.snippet-list',
          groupSelector: '.folder-group',
          groupAttribute: 'data-is-master',
          nameAttribute: 'data-folder',
          idAttribute: 'data-id',
          folderAttribute: 'data-folder',
          
          onFolderReorder: async (newOrder, isMaster) => {
            if (isMaster) {
              const folderOrder = new Map(newOrder.map((f, i) => [f, i]));
              masterSnippets.sort((a, b) => {
                const orderA = folderOrder.get(a.folder) ?? 999;
                const orderB = folderOrder.get(b.folder) ?? 999;
                return orderA - orderB;
              });
              
              const orderData = masterSnippets.map(s => ({ id: s.id, folder: s.folder }));
              await ipcRenderer.invoke('save-master-order', orderData);
            } else {
              folders.length = 0;
              folders.push(...newOrder);
              await ipcRenderer.invoke('save-personal-folders', folders);
            }
            await loadData();
            render();
          },
          
          onItemReorder: async (draggedId, targetId, folderName, isMaster) => {
            if (isMaster) {
              await reorderMasterSnippet(draggedId, targetId, folderName);
            } else {
              await reorderPersonalSnippet(draggedId, targetId, folderName);
            }
          },
          
          onItemDropToEnd: async (draggedId, folderName, isMaster) => {
            await moveSnippetToEnd(draggedId, folderName, isMaster);
          }
        });
        
        dragDropManager.init();
      }
      
      dragDropManager.attachEvents();
    }

    async function reorderMasterSnippet(draggedId, targetId, folderName) {
      const folderSnippets = masterSnippets.filter(s => s.folder === folderName);
      const otherSnippets = masterSnippets.filter(s => s.folder !== folderName);
      
      const draggedSnippet = folderSnippets.find(s => s.id === draggedId);
      const targetSnippet = folderSnippets.find(s => s.id === targetId);
      
      if (!draggedSnippet || !targetSnippet) return;
      
      const draggedIdx = folderSnippets.indexOf(draggedSnippet);
      const targetIdx = folderSnippets.indexOf(targetSnippet);

      folderSnippets.splice(draggedIdx, 1);
      const newIdx = draggedIdx < targetIdx ? targetIdx - 1 : targetIdx;
      folderSnippets.splice(newIdx, 0, draggedSnippet);
      
      const currentOrder = await ipcRenderer.invoke('get-master-order');
      const existingFolderOrder = [...new Set(currentOrder.map(item => item.folder))];
      
      const allSnippetsReordered = [...otherSnippets, ...folderSnippets];
      const folderOrder = new Map(existingFolderOrder.map((f, i) => [f, i]));
      
      allSnippetsReordered.sort((a, b) => {
        const orderA = folderOrder.get(a.folder) ?? 999;
        const orderB = folderOrder.get(b.folder) ?? 999;
        if (orderA !== orderB) return orderA - orderB;
        
        if (a.folder === folderName && b.folder === folderName) {
          return folderSnippets.indexOf(a) - folderSnippets.indexOf(b);
        }
        return 0;
      });
      
      const orderData = allSnippetsReordered.map(s => ({ id: s.id, folder: s.folder }));
      await ipcRenderer.invoke('save-master-order', orderData);
      
      await loadData();
      render();
    }

    async function reorderPersonalSnippet(draggedId, targetId, folderName) {
      const folderSnippets = personalSnippets.filter(s => s.folder === folderName);
      
      const draggedSnippet = folderSnippets.find(s => s.id === draggedId);
      const targetSnippet = folderSnippets.find(s => s.id === targetId);
      
      if (!draggedSnippet || !targetSnippet) return;
      
      const draggedIdx = folderSnippets.indexOf(draggedSnippet);
      const targetIdx = folderSnippets.indexOf(targetSnippet);

      folderSnippets.splice(draggedIdx, 1);
      const newIdx = draggedIdx < targetIdx ? targetIdx - 1 : targetIdx;
      folderSnippets.splice(newIdx, 0, draggedSnippet);
      
      personalSnippets = personalSnippets.filter(s => s.folder !== folderName).concat(folderSnippets);
      
      await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      await loadData();
      render();
    }

    async function moveSnippetToEnd(draggedId, folderName, isMaster) {
      if (isMaster) {
        const folderSnippets = masterSnippets.filter(s => s.folder === folderName);
        const otherSnippets = masterSnippets.filter(s => s.folder !== folderName);
        
        const draggedSnippet = folderSnippets.find(s => s.id === draggedId);
        if (!draggedSnippet) return;
        
        const draggedIdx = folderSnippets.indexOf(draggedSnippet);
        folderSnippets.splice(draggedIdx, 1);
        folderSnippets.push(draggedSnippet);
        
        const currentOrder = await ipcRenderer.invoke('get-master-order');
        const existingFolderOrder = [...new Set(currentOrder.map(item => item.folder))];
        
        const allSnippetsReordered = [...otherSnippets, ...folderSnippets];
        const folderOrder = new Map(existingFolderOrder.map((f, i) => [f, i]));
        
        allSnippetsReordered.sort((a, b) => {
          const orderA = folderOrder.get(a.folder) ?? 999;
          const orderB = folderOrder.get(b.folder) ?? 999;
          if (orderA !== orderB) return orderA - orderB;
          
          if (a.folder === folderName && b.folder === folderName) {
            return folderSnippets.indexOf(a) - folderSnippets.indexOf(b);
          }
          return 0;
        });
        
        const orderData = allSnippetsReordered.map(s => ({ id: s.id, folder: s.folder }));
        await ipcRenderer.invoke('save-master-order', orderData);
      } else {
        const folderSnippets = personalSnippets.filter(s => s.folder === folderName);
        
        const draggedSnippet = folderSnippets.find(s => s.id === draggedId);
        if (!draggedSnippet) return;
        
        const draggedIdx = folderSnippets.indexOf(draggedSnippet);
        folderSnippets.splice(draggedIdx, 1);
        folderSnippets.push(draggedSnippet);
        
        personalSnippets = personalSnippets.filter(s => s.folder !== folderName).concat(folderSnippets);
        
        await ipcRenderer.invoke('save-personal-snippets', personalSnippets);
      }
      
      await loadData();
      render();
    }

    document.addEventListener('keydown', (e) => {
      // ãƒªãƒãƒ¼ãƒ ä¸­ã¯ç„¡è¦–
      if (document.activeElement.classList.contains('rename-input')) {
        return;
      }

      // INPUTè¦ç´ ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãªã©ï¼‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã¯ç„¡è¦–
      if (document.activeElement.tagName === 'INPUT') {
        return;
      }

      // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
      const activeId = document.activeElement.id;
      if (activeId === 'snippet-content' || activeId === 'snippet-description') {
        // Enterã‚­ãƒ¼ã¯æ”¹è¡Œå…¥åŠ›ãªã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã‚’è¨±å¯
        if (e.key === 'Enter') {
          return;
        }
        
        // Escapeã‚­ãƒ¼ã§ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«æˆ»ã‚‹
        if (e.key === 'Escape') {
          e.preventDefault();
          focusPane('sidebar');
          return;
        }
        
        // ãã®ä»–ã®ã‚­ãƒ¼ï¼ˆçŸ¢å°ã‚­ãƒ¼ãªã©ï¼‰ã¯handleEditorKeydownã§å‡¦ç†
        handleEditorKeydown(e);
        return;
      }

      // ãƒšã‚¤ãƒ³ãŒsidebarä»¥å¤–ã®å ´åˆï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§æ˜ç¤ºçš„ã«ç§»å‹•ã—ãŸå ´åˆï¼‰
      if (currentPane !== 'sidebar') {
        handleEditorKeydown(e);
        return;
      }

      const allItems = [];
      
      // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆç©ºãƒ•ã‚©ãƒ«ãƒ€ã‚‚å«ã‚€ï¼‰
      const allMasterFolders = [...new Set([...masterFolders, ...masterSnippets.map(s => s.folder)])];
      allMasterFolders.forEach(folder => {
        allItems.push({ type: 'folder', name: folder });
        if (expandedFolders.has(folder)) {
          masterSnippets.filter(s => s.folder === folder).forEach(snippet => {
            allItems.push({ type: 'snippet', id: snippet.id, name: snippet.title });
          });
        }
      });
      
      // å€‹åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ã¯foldersã‚’ãã®ã¾ã¾ä½¿ç”¨
      const personalFolders = folders;
      personalFolders.forEach(folder => {
        allItems.push({ type: 'folder', name: folder });
        if (expandedFolders.has(folder)) {
          personalSnippets.filter(s => s.folder === folder).forEach(snippet => {
            allItems.push({ type: 'snippet', id: snippet.id, name: snippet.title });
          });
        }
      });

      let currentIndex = -1;
      if (selectedFolder) {
        currentIndex = allItems.findIndex(item => item.type === 'folder' && item.name === selectedFolder);
      } else if (selectedSnippet) {
        currentIndex = allItems.findIndex(item => item.type === 'snippet' && item.id === selectedSnippet.id);
      }

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        let nextIndex = currentIndex + 1;
        if (nextIndex >= allItems.length) {
          nextIndex = 0;
        }
        if (nextIndex >= 0 && nextIndex < allItems.length) {
          const nextItem = allItems[nextIndex];
          if (nextItem.type === 'folder') {
            selectFolder(nextItem.name);
          } else {
            selectSnippet(nextItem.id);
          }
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        let prevIndex = currentIndex - 1;
        if (prevIndex < 0) {
          prevIndex = allItems.length - 1;
        }
        if (prevIndex >= 0 && prevIndex < allItems.length) {
          const prevItem = allItems[prevIndex];
          if (prevItem.type === 'folder') {
            selectFolder(prevItem.name);
          } else {
            selectSnippet(prevItem.id);
          }
        }
      } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        if (selectedFolder) {
          // ãƒ•ã‚©ãƒ«ãƒ€ãŒé–‰ã˜ã¦ãŸã‚‰é–‹ãã€é–‹ã„ã¦ãŸã‚‰contentã¸
          if (!expandedFolders.has(selectedFolder)) {
            toggleFolder(selectedFolder);
          }
        } else if (selectedSnippet && !selectedSnippet.isMaster) {
          // å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆé¸æŠä¸­ã¯contentã¸ï¼ˆãƒã‚¹ã‚¿ã¯é™¤ãï¼‰
          focusPane('content');
        }
      } else if (e.key === 'ArrowLeft' && selectedFolder) {
        e.preventDefault();
        if (expandedFolders.has(selectedFolder)) {
          toggleFolder(selectedFolder);
        }
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (selectedFolder) {
          toggleFolder(selectedFolder);
        } else if (selectedSnippet && !selectedSnippet.isMaster) {
          startRenameSnippet(selectedSnippet.id);
        }
      } else if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault();
        deleteSelected();
      }
    });



    function moveToNextItem() {
      const allItems = [];
      
      // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆç©ºãƒ•ã‚©ãƒ«ãƒ€ã‚‚å«ã‚€ï¼‰
      const allMasterFolders = [...new Set([...masterFolders, ...masterSnippets.map(s => s.folder)])];
      allMasterFolders.forEach(folder => {
        allItems.push({ type: 'folder', name: folder });
        if (expandedFolders.has(folder)) {
          masterSnippets.filter(s => s.folder === folder).forEach(snippet => {
            allItems.push({ type: 'snippet', id: snippet.id, name: snippet.title });
          });
        }
      });
      
      // å€‹åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ã¯foldersã‚’ãã®ã¾ã¾ä½¿ç”¨
      const personalFolders = folders;
      personalFolders.forEach(folder => {
        allItems.push({ type: 'folder', name: folder });
        if (expandedFolders.has(folder)) {
          personalSnippets.filter(s => s.folder === folder).forEach(snippet => {
            allItems.push({ type: 'snippet', id: snippet.id, name: snippet.title });
          });
        }
      });

      let currentIndex = -1;
      if (selectedFolder) {
        currentIndex = allItems.findIndex(item => item.type === 'folder' && item.name === selectedFolder);
      } else if (selectedSnippet) {
        currentIndex = allItems.findIndex(item => item.type === 'snippet' && item.id === selectedSnippet.id);
      }

      const nextIndex = Math.min(currentIndex + 1, allItems.length - 1);
      if (nextIndex >= 0 && nextIndex < allItems.length && nextIndex !== currentIndex) {
        const nextItem = allItems[nextIndex];
        if (nextItem.type === 'folder') {
          selectFolder(nextItem.name);
        } else {
          selectSnippet(nextItem.id);
        }
      }
    }

    init();

    // ========================================
    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
    // ========================================
    function showExportDialog() {
      const modal = document.getElementById('export-modal');
      const folderList = document.getElementById('export-folder-list');
      
      // ãƒã‚¹ã‚¿ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§
      const masterFolderNames = [...new Set(masterSnippets.map(s => s.folder))];
      // å€‹åˆ¥ãƒ•ã‚©ãƒ«ãƒ€ä¸€è¦§
      const personalFolderNames = [...folders];
      
      let html = '';
      
      // ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
      if (masterFolderNames.length > 0) {
        html += `<div style="font-size: 11px; font-weight: 600; color: #86868b; margin: 8px 0 4px 0;">ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>`;
        masterFolderNames.forEach(folder => {
          const count = masterSnippets.filter(s => s.folder === folder).length;
          html += `
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 8px; border-radius: 4px;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" class="export-folder-checkbox" data-folder="${escapeAttr(folder)}" data-type="master" onchange="updateSelectAllState()">
              <span style="flex: 1;">${escapeHtml(folder)}</span>
              <span style="font-size: 11px; color: #86868b;">${count}ä»¶</span>
            </label>
          `;
        });
      }
      
      // å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
      if (personalFolderNames.length > 0) {
        html += `<div style="font-size: 11px; font-weight: 600; color: #86868b; margin: 12px 0 4px 0;">å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆ</div>`;
        personalFolderNames.forEach(folder => {
          const count = personalSnippets.filter(s => s.folder === folder).length;
          html += `
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px 8px; border-radius: 4px;" onmouseover="this.style.background='#f5f5f7'" onmouseout="this.style.background='transparent'">
              <input type="checkbox" class="export-folder-checkbox" data-folder="${escapeAttr(folder)}" data-type="personal" onchange="updateSelectAllState()">
              <span style="flex: 1;">${escapeHtml(folder)}</span>
              <span style="font-size: 11px; color: #86868b;">${count}ä»¶</span>
            </label>
          `;
        });
      }
      
      if (masterFolderNames.length === 0 && personalFolderNames.length === 0) {
        html = '<div style="color: #86868b; text-align: center; padding: 20px;">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹ã‚¹ãƒ‹ãƒšãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
      
      folderList.innerHTML = html;
      
      // ã€Œã™ã¹ã¦é¸æŠã€ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('export-select-all').checked = false;
      
      modal.style.display = 'flex';
    }

    function hideExportDialog() {
      document.getElementById('export-modal').style.display = 'none';
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('export-select-all').checked;
      document.querySelectorAll('.export-folder-checkbox').forEach(cb => {
        cb.checked = selectAll;
      });
    }

    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('.export-folder-checkbox');
      const allChecked = [...checkboxes].every(cb => cb.checked);
      document.getElementById('export-select-all').checked = allChecked;
    }

    async function executeExport() {
      // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã‚’å–å¾—
      const selectedFolders = [];
      document.querySelectorAll('.export-folder-checkbox:checked').forEach(cb => {
        selectedFolders.push({
          folder: cb.dataset.folder,
          type: cb.dataset.type
        });
      });
      
      if (selectedFolders.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’åé›†
      let snippetsToExport = [];
      
      selectedFolders.forEach(({ folder, type }) => {
        if (type === 'master') {
          snippetsToExport.push(...masterSnippets.filter(s => s.folder === folder));
        } else {
          snippetsToExport.push(...personalSnippets.filter(s => s.folder === folder));
        }
      });
      
      if (snippetsToExport.length === 0) {
        alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã‚¹ãƒ‹ãƒšãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ±ºå®š
      let filename = 'snippets.xml';
      if (selectedFolders.length === 1) {
        filename = `${selectedFolders[0].folder}.xml`;
      } else {
        const hasMaster = selectedFolders.some(f => f.type === 'master');
        const hasPersonal = selectedFolders.some(f => f.type === 'personal');
        if (hasMaster && !hasPersonal) {
          filename = 'master-snippets.xml';
        } else if (!hasMaster && hasPersonal) {
          filename = 'personal-snippets.xml';
        } else {
          filename = 'selected-snippets.xml';
        }
      }
      
      // XMLã‚’ç”Ÿæˆ
      const xml = generateClipyXML(snippetsToExport);
      
      // ä¿å­˜
      const result = await ipcRenderer.invoke('export-snippets-xml', { xml, filename });
      
      if (result.success) {
        alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†: ${result.path}\nï¼ˆ${snippetsToExport.length}ä»¶ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆï¼‰`);
      } else if (result.cancelled) {
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ä½•ã‚‚ã—ãªã„
        return;
      } else {
        alert(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¤±æ•—: ${result.error}`);
      }
      
      hideExportDialog();
    }

    function generateClipyXML(snippets) {
      // ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const folderGroups = {};
      snippets.forEach(s => {
        const folderName = s.folder || 'æœªåˆ†é¡';
        if (!folderGroups[folderName]) {
          folderGroups[folderName] = [];
        }
        folderGroups[folderName].push(s);
      });
      
      // XMLç”Ÿæˆ
      let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<folders>\n';
      
      Object.entries(folderGroups).forEach(([folderName, folderSnippets]) => {
        xml += `  <folder>\n`;
        xml += `    <title>${escapeXml(folderName)}</title>\n`;
        xml += `    <snippets>\n`;
        
        folderSnippets.forEach(snippet => {
          xml += `      <snippet>\n`;
          if (snippet.id) {
            xml += `        <id>${escapeXml(snippet.id)}</id>\n`;
          }
          xml += `        <title>${escapeXml(snippet.title || '')}</title>\n`;
          xml += `        <content>${escapeXml(snippet.content || '')}</content>\n`;
          if (snippet.description) {
            xml += `        <description>${escapeXml(snippet.description)}</description>\n`;
          }
          xml += `      </snippet>\n`;
        });
        
        xml += `    </snippets>\n`;
        xml += `  </folder>\n`;
      });
      
      xml += '</folders>';
      
      return xml;
    }
    
    function escapeXml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&apos;');
    }

    // ========================================
    // ãƒã‚¹ã‚¿ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
    // ========================================
    function updateMasterEditButton() {
      const btn = document.getElementById('master-edit-btn');
      if (masterSnippets.length > 0 || masterFolders.length > 0) {
        btn.style.display = 'flex';
        if (isMasterEditMode) {
          btn.innerHTML = '<span>ğŸ”“ ç·¨é›†ä¸­</span>';
          btn.style.background = '#e8f5e9';
          btn.style.borderColor = '#34c759';
        } else {
          btn.innerHTML = '<span>ğŸ”’ ãƒã‚¹ã‚¿ç·¨é›†</span>';
          btn.style.background = '';
          btn.style.borderColor = '';
        }
      } else {
        btn.style.display = 'none';
      }
    }

    function showMasterPasswordDialog() {
      if (isMasterEditMode) {
        // æ—¢ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã‚‰OFFã«
        isMasterEditMode = false;
        updateMasterEditButton();
        if (selectedSnippet) showEditor();
        return;
      }
      
      document.getElementById('master-password-modal').style.display = 'flex';
      document.getElementById('master-password-input').value = '';
      document.getElementById('master-password-error').style.display = 'none';
      setTimeout(() => document.getElementById('master-password-input').focus(), 100);
    }

    function hideMasterPasswordDialog() {
      document.getElementById('master-password-modal').style.display = 'none';
    }

    async function verifyMasterPassword() {
      const password = document.getElementById('master-password-input').value;
      const isValid = await ipcRenderer.invoke('verify-master-password', password);
      
      if (isValid) {
        isMasterEditMode = true;
        hideMasterPasswordDialog();
        updateMasterEditButton();
        if (selectedSnippet) showEditor();
      } else {
        document.getElementById('master-password-error').style.display = 'block';
        document.getElementById('master-password-input').select();
      }
    }
  </script>
</body>
</html>