<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Snipee è¨­å®š</title>
  <link rel="stylesheet" href="common/variables.css">
  <link rel="stylesheet" href="common/common.css">
  <script src="common/utils.js"></script>
  <style>
    /* settings.html å›ºæœ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿ */
    body {
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      width: 500px;
      height: 400px;
      max-height: 95vh;
      background: var(--bg-color);
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--bg-color);
      padding: 5px 20px;
      border-bottom: 1px solid var(--border-color);
      -webkit-app-region: drag;
    }
    
    .header h1 {
      font-size: var(--font-size-normal);
      font-weight: 600;
      color: var(--text-color);
      margin: 0;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tabs {
      display: flex;
      background: #f5f5f5;
      border-bottom: 1px solid #d0d0d0;
      padding: 0;
      -webkit-app-region: drag;
    }

    .tab {
      padding: 2px 10px;
      cursor: pointer;
      border: none;
      background: transparent;
      font-size: var(--font-size-small); 
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
      flex: 1;
      justify-content: center;
      -webkit-app-region: no-drag;
    }

    .tab span:first-child {
      font-size: 18px;
    }

    .tab span:last-child {
      font-size: var(--font-size-small);
      font-weight: 600;
    }

    .tab:hover {
      background: rgba(0,0,0,0.05);
      color: var(--text-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: var(--bg-color);
    }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .content {
      flex: 1;
      overflow-y: auto;
      -webkit-app-region: no-drag;
    }

    .tab-content {
      display: none;
      padding: 12px;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      background: transparent;
      padding: 10px;
      border-radius: 0;
      margin-bottom: 10px;
      border: none;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .section-header h2 {
      font-size: var(--font-size-medium);
      font-weight: 600;
      color: var(--text-color);
    }

    .section-description {
      font-size: var(--font-size-small);
      color: #777;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .form-group {
      margin-bottom: 10px;
      -webkit-app-region: no-drag;
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      margin-bottom: 4px;
      color: #444;
      font-size: 12px;
      font-weight: 500;
      -webkit-app-region: no-drag;
    }

    input[type="text"],
    input[type="url"] {
      width: 100%;
      padding: 7px 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 12px;
      font-family: var(--font-family);
      transition: all 0.2s;
      background: var(--bg-color);
      -webkit-app-region: no-drag;
    }

    input[type="text"]:focus,
    input[type="url"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    input[readonly] {
      background: #f5f5f5;
      cursor: not-allowed;
      color: #666;
    }

    .help-text {
      font-size: 10px;
      color: #888;
      margin-top: 3px;
      line-height: 1.3;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      -webkit-app-region: no-drag;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0051d5;
    }

    .btn-success {
      background: #34c759;
      color: white;
    }

    .btn-success:hover {
      background: #2da64a;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: var(--text-color);
      border: 1px solid #ddd;
    }

    .btn-secondary:hover {
      background: #e5e5e5;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .alert {
      padding: 8px 10px;
      border-radius: var(--border-radius);
      margin-bottom: 8px;
      font-size: var(--font-size-small);
      display: none;
      align-items: center;
      gap: 6px;
    }

    .alert.show {
      display: flex;
    }

    .alert-success {
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      color: #2e7d32;
    }

    .alert-error {
      background: #ffebee;
      border: 1px solid #ef9a9a;
      color: #c62828;
    }

    .alert-info {
      background: #e3f2fd;
      border: 1px solid #90caf9;
      color: #1565c0;
    }

    .link-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .link-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 12px;
      transition: all 0.2s;
      -webkit-app-region: no-drag;
    }

    .link-item:hover {
      background: #f8f9fa;
      border-color: var(--primary-color);
    }

    .link-item a {
      color: var(--primary-color);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1;
    }

    .link-item a:hover {
      text-decoration: underline;
    }

    .hotkey-display {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .hotkey-display label {
      margin-bottom: 0;
      min-width: 100px;
    }

    .hotkey-display input {
      flex: 1;
    }

    .hotkey-display .btn {
      flex-shrink: 0;
    }

    .sync-status {
      background: var(--bg-color);
      padding: 8px 10px;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      font-size: var(--font-size-small);
      color: #666;
      margin-top: 8px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.4);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      -webkit-app-region: no-drag;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      -webkit-app-region: no-drag;
    }

    .modal-header {
      margin-bottom: 12px;
    }

    .modal-header h3 {
      font-size: var(--font-size-large);
      font-weight: 600;
      color: var(--text-color);
    }

    .modal-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .keyboard-focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‹ Snipee è¨­å®š</h1>
    </div>

    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'general')">
        <span>ğŸ“–</span>
        <span>ä¸€èˆ¬</span>
      </button>
      <button class="tab" onclick="switchTab(event, 'shortcuts')">
        <span>âŒ¨ï¸</span>
        <span>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</span>
      </button>
      <button class="tab" onclick="switchTab(event, 'sync')">
        <span>ğŸ”„</span>
        <span>åŒæœŸ</span>
      </button>
      <button class="tab" onclick="switchTab(event, 'display')">
        <span>âš™ï¸</span>
        <span>è¡¨ç¤º</span>
      </button>
    </div>

    <div class="content">
      <!-- ä¸€èˆ¬ã‚¿ãƒ– -->
      <div class="tab-content active" id="general-tab">
        <div class="section">
          <div class="section-header">
            <h2>ğŸ“– ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</h2>
          </div>
          <div class="section-description">
            Snipeeã®ä½¿ã„æ–¹ã‚„è©³ç´°æƒ…å ±ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚
          </div>
          
          <div class="link-list">
            <div class="link-item">
              <a href="#" onclick="openExternal('https://docs.google.com/document/d/19ozUsoWsoq7Vt9lC2hH7ZmRQaU_HPOed/edit?usp=drive_link&ouid=100169480111493407616&rtpof=true&sd=true'); return false;">
                ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰
              </a>
            </div>
            <div class="link-item">
              <a href="#" onclick="openExternal('https://docs.google.com/document/d/1ShxU1i7eDGGHDAsq24cwn5cl6F0i8X-_/edit?usp=drive_link&ouid=100169480111493407616&rtpof=true&sd=true'); return false;">
                ğŸ“‹ ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’è²¼ã‚Šä»˜ã‘ã‚‹
              </a>
            </div>
            <div class="link-item">
              <a href="#" onclick="openExternal('https://docs.google.com/document/d/1HA-y_kQaQ6zoLpXR4bylGP1DBGP6US-f/edit?usp=drive_link&ouid=100169480111493407616&rtpof=true&sd=true'); return false;">
                ğŸ“ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰å±¥æ­´ã‚’ä½¿ã†
              </a>
            </div>
            <div class="link-item">
              <a href="#" onclick="openExternal('https://docs.google.com/document/d/1xHKgNhkBlOJk8HnpK5qap6MYMhquqOxc/edit?usp=sharing&ouid=100169480111493407616&rtpof=true&sd=true'); return false;">
                â“ å›°ã£ãŸã¨ãï¼ˆFAQï¼‰
              </a>
            </div>
          </div>
        </div>

        <!-- ğŸ†• ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
          <div class="section-header">
            <h2>ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</h2>
          </div>
          <div class="section-description">
            ã‚¹ãƒ‹ãƒšãƒƒãƒˆå†…ã®å¤‰æ•°ã«ä½¿ç”¨ã•ã‚Œã‚‹æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚
          </div>
          
          <div class="form-group">
            <label>åå‰</label>
            <input 
              type="text" 
              id="user-name" 
              placeholder="å±±ç”°å¤ªéƒ"
            />
            <div class="help-text">
              ã‚¹ãƒ‹ãƒšãƒƒãƒˆå†…ã® {åå‰} å¤‰æ•°ã«ä½¿ç”¨ã•ã‚Œã¾ã™
            </div>
          </div>
        </div>
      </div>

      <!-- ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚¿ãƒ– -->
      <div class="tab-content" id="shortcuts-tab">
        <div class="section">
          <div class="section-header">
            <h2>âŒ¨ï¸ ãƒ›ãƒƒãƒˆã‚­ãƒ¼è¨­å®š</h2>
          </div>
          <div class="section-description">
            ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰å±¥æ­´ã¨ã‚¹ãƒ‹ãƒšãƒƒãƒˆå°‚ç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ããƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ã€‚
          </div>
          
          <div class="form-group">
            <div class="hotkey-display">
              <label>ç°¡æ˜“ãƒ›ãƒ¼ãƒ </label>
              <input type="text" id="hotkey-main" readonly>
              <button class="btn btn-secondary" onclick="showHotkeyModal('main')">å¤‰æ›´</button>
            </div>
            <div class="help-text">
              ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰å±¥æ­´ã‚’é–‹ãã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: <span id="default-main">Command+Control+C</span>ï¼‰
            </div>
          </div>

          <div class="form-group">
            <div class="hotkey-display">
              <label>ã‚¹ãƒ‹ãƒšãƒƒãƒˆå°‚ç”¨</label>
              <input type="text" id="hotkey-snippet" readonly>
              <button class="btn btn-secondary" onclick="showHotkeyModal('snippet')">å¤‰æ›´</button>
            </div>
            <div class="help-text">
              ã‚¹ãƒ‹ãƒšãƒƒãƒˆä¸€è¦§ã‚’é–‹ãã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: <span id="default-snippet">Command+Control+V</span>ï¼‰
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="resetAllHotkeys()">ğŸ”„ ã™ã¹ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
          </div>
        </div>

        <div id="shortcut-alert" class="alert"></div>
      </div>

      <!-- åŒæœŸã‚¿ãƒ– -->
      <div class="tab-content" id="sync-tab">
        <div class="section">
          <div class="section-header">
            <h2>ğŸ”„ å…±æœ‰ã‚¹ãƒ‹ãƒšãƒƒãƒˆåŒæœŸ</h2>
          </div>
          <div class="section-description">
            Google Driveã§ãƒãƒ¼ãƒ å…¨ä½“ã®ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’å…±æœ‰ã§ãã¾ã™ã€‚XMLå½¢å¼ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€å…±æœ‰ãƒªãƒ³ã‚¯ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
          </div>
          
          <div id="sync-alert" class="alert"></div>

          <div class="form-group">
            <label>Google Driveå…±æœ‰ãƒªãƒ³ã‚¯URL</label>
            <input type="url" id="master-url" placeholder="https://drive.google.com/file/d/...">
            <div class="help-text">
              ãƒ•ã‚¡ã‚¤ãƒ« â†’ å…±æœ‰ â†’ ãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ â†’ ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼
            </div>
          </div>
          
          <div class="btn-group">
            <button class="btn btn-primary" onclick="saveMasterUrl()">ğŸ’¾ ä¿å­˜ã—ã¦åŒæœŸ</button>
            <button class="btn btn-success" onclick="manualSync()">ğŸ”„ æ‰‹å‹•åŒæœŸ</button>
            <button class="btn btn-secondary" onclick="removeMasterUrl()">ğŸ—‘ï¸ åŒæœŸè§£é™¤</button>
          </div>

          <div class="sync-status" id="sync-status">
            æœ€çµ‚åŒæœŸ: æœªåŒæœŸ
          </div>
        </div>
      </div>

      <!-- è¡¨ç¤ºã‚¿ãƒ– -->
      <div class="tab-content" id="display-tab">
        <div class="section">
          <div class="section-header">
            <h2>ğŸ‘ï¸ ãƒ•ã‚©ãƒ«ãƒ€ã®è¡¨ç¤ºè¨­å®š</h2>
          </div>
          <div class="section-description">
            è¡¨ç¤ºã—ãŸããªã„ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦ãã ã•ã„ã€‚ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã¯ç°¡æ˜“ãƒ›ãƒ¼ãƒ ã¨ã‚¹ãƒ‹ãƒšãƒƒãƒˆå°‚ç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«è¡¨ç¤ºã•ã‚Œãªããªã‚Šã¾ã™ã€‚
          </div>
          
          <div id="folder-alert" class="alert"></div>

          <div id="folder-list" style="max-height: 300px; overflow-y: auto; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px;">
            <div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
              ãƒ•ã‚©ãƒ«ãƒ€ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
            </div>
          </div>

          <div class="btn-group" style="margin-top: 8px;">
            <button class="btn btn-primary" onclick="saveFolderSettings()">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
            <button class="btn btn-secondary" onclick="selectAllFolders()">â˜‘ï¸ ã™ã¹ã¦è¡¨ç¤º</button>
            <button class="btn btn-secondary" onclick="deselectAllFolders()">â˜ ã™ã¹ã¦éè¡¨ç¤º</button>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>ğŸ“ ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ä½ç½®è¨­å®š</h2>
          </div>
          <div class="section-description">
            ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®è¡¨ç¤ºä½ç½®ã‚’è¨­å®šã§ãã¾ã™ã€‚
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="windowPosition" value="cursor" style="margin-right: 8px;">
              <span>ãƒã‚¦ã‚¹ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã«è¡¨ç¤º</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
              <input type="radio" name="windowPosition" value="previous" style="margin-right: 8px;">
              <span>å‰å›ã®ä½ç½®ã«è¡¨ç¤º</span>
            </label>
          </div>
          <p style="margin: 8px 0 0 0; font-size: 11px; color: #666;">
            ã€Œå‰å›ã®ä½ç½®ã€ã‚’é¸ã¶ã¨ã€ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ç§»å‹•ã—ãŸä½ç½®ã‚’è¨˜æ†¶ã—ã¾ã™
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ›ãƒƒãƒˆã‚­ãƒ¼å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal" id="hotkey-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’å¤‰æ›´</h3>
      </div>
      
      <div class="form-group">
        <label>æ–°ã—ã„ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„</label>
        <input type="text" id="hotkey-input" readonly placeholder="ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„..." 
              style="font-size: 16px; text-align: center; padding: 16px; background: #f8f9fa;">
        <div class="help-text">
          Modifierã‚­ãƒ¼ï¼ˆCommand, Control, Alt, Shiftï¼‰ã¨ã‚­ãƒ¼ã®çµ„ã¿åˆã‚ã›ã‚’æŠ¼ã—ã¦ãã ã•ã„
        </div>
      </div>

      <div id="hotkey-error" style="display: none; color: #dc3545; font-size: 12px; margin-top: 8px; padding: 8px; background: #ffebee; border-radius: 4px;">
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeHotkeyModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="save-hotkey-btn" onclick="saveHotkey()" disabled>ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer, shell } = require('electron');
    const Store = require('electron-store');
    const store = new Store();

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    const tabNames = ['general', 'shortcuts', 'sync', 'display'];
    let currentTabIndex = 0;
    let nav; // KeyboardNavigator
    
    let capturedHotkey = null;
    let currentEditingType = null;

    const isMac = process.platform === 'darwin';

    window.addEventListener('DOMContentLoaded', async () => {
      if (!isMac) {
        document.getElementById('default-main').textContent = 'Ctrl+Alt+C';
        document.getElementById('default-snippet').textContent = 'Ctrl+Alt+V';
      }

      await loadHotkeys();
      await loadSyncStatus();

      const defaultUrl = 'https://drive.google.com/file/d/1MIHYx_GUjfqv591h6rzIbcxm_FQZwAXY/view?usp=sharing';
      const masterUrl = store.get('masterSnippetUrl', defaultUrl);
      document.getElementById('master-url').value = masterUrl;

      await loadFolders();
      loadWindowPositionSetting();

      // ğŸ†• åå‰ã‚’èª­ã¿è¾¼ã¿
      const userName = store.get('userName', '');
      document.getElementById('user-name').value = userName;

      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      document.getElementById('hotkey-modal').addEventListener('click', (e) => {
        if (e.target.id === 'hotkey-modal') {
          closeHotkeyModal();
        }
      });

      // ãƒ›ãƒƒãƒˆã‚­ãƒ¼å…¥åŠ›
      document.getElementById('hotkey-input').addEventListener('keydown', (e) => {
        if (!document.getElementById('hotkey-modal').classList.contains('show')) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        let key = e.code;

        if (['MetaLeft', 'MetaRight', 'ControlLeft', 'ControlRight', 'AltLeft', 'AltRight', 'ShiftLeft', 'ShiftRight'].includes(key)) {
          return;
        }

        if (key.startsWith('Key')) {
          key = key.replace('Key', '');
        } else if (key.startsWith('Digit')) {
          key = key.replace('Digit', '');
        } else {
          key = e.key;
        }
        
        const modifiers = [];
        if (e.metaKey) modifiers.push('Command');
        if (e.ctrlKey && !e.metaKey) modifiers.push('Control');
        if (e.altKey) modifiers.push('Alt');  
        if (e.shiftKey) modifiers.push('Shift');
        
        if (modifiers.length === 0) {
          document.getElementById('hotkey-error').textContent = 'âš ï¸ Modifierã‚­ãƒ¼ï¼ˆCommand, Control, Alt, Shiftï¼‰ã¨çµ„ã¿åˆã‚ã›ã¦ãã ã•ã„';
          document.getElementById('hotkey-error').style.display = 'block';
          document.getElementById('save-hotkey-btn').disabled = true;
          return;
        }
        
        const hotkeyStr = [...modifiers, key].join('+');
        
        document.getElementById('hotkey-input').value = hotkeyStr;
        capturedHotkey = hotkeyStr;
        
        document.getElementById('hotkey-error').style.display = 'none';
        document.getElementById('save-hotkey-btn').disabled = false;
      });

      // Escã‚­ãƒ¼å‡¦ç†
      // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
      // KeyboardNavigatoråˆæœŸåŒ–
      nav = new KeyboardNavigator({
        selectedClass: 'keyboard-focus',
        onEscape: () => {
          const modal = document.getElementById('hotkey-modal');
          if (modal.classList.contains('show')) {
            closeHotkeyModal();
          } else {
            const isInputFocused = document.activeElement.tagName === 'INPUT' && 
                                   !document.activeElement.readOnly;
            if (isInputFocused) {
              document.activeElement.blur();
            } else {
              ipcRenderer.invoke('hide-settings-window');
            }
          }
        },
        onEnter: (item) => {
          if (item) {
            if (item.type === 'checkbox') {
              item.checked = !item.checked;
            } else {
              item.click();
            }
          }
        },
        onLeft: () => {
          currentTabIndex = (currentTabIndex - 1 + tabNames.length) % tabNames.length;
          switchTabByIndex(currentTabIndex);
        },
        onRight: () => {
          currentTabIndex = (currentTabIndex + 1) % tabNames.length;
          switchTabByIndex(currentTabIndex);
        }
      });
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»å…¥åŠ›ä¸­ã®ç‰¹æ®Šå‡¦ç†ã‚’ãƒ©ãƒƒãƒ—
      document.addEventListener('keydown', (e) => {
        const modal = document.getElementById('hotkey-modal');
        if (modal.classList.contains('show') && e.key !== 'Escape') {
          return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­ã¯Escä»¥å¤–ç„¡è¦–
        }
        
        const isInputFocused = document.activeElement.tagName === 'INPUT' && 
                               !document.activeElement.readOnly;
        if (isInputFocused && e.key !== 'Escape') {
          return; // å…¥åŠ›ä¸­ã¯Escä»¥å¤–ç„¡è¦–
        }
        
        nav.handleKeyDown(e);
      });
      
      // åˆæœŸåŒ–æ™‚ã«ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–°
      updateSelectableItems();
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(event, tabName) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      event.currentTarget.classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTabByIndex(index) {
      currentTabIndex = index;
      const tabs = document.querySelectorAll('.tab');
      const tabName = tabNames[index];
      
      // ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      tabs.forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // é¸æŠã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      tabs[index].classList.add('active');
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // ã‚¿ãƒ–å†…ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
      updateSelectableItems();
    }

    // é¸æŠå¯èƒ½ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
    function updateSelectableItems() {
      const activeTab = document.querySelector('.tab-content.active');
      const selector = '.link-item, .btn, input:not([readonly]), input[type="checkbox"]';
      nav.selectableItems = Array.from(activeTab.querySelectorAll(selector));
      nav.selectedIndex = 0;
      nav.updateVisual();
    }

    // ğŸ†• åå‰ã®ä¿å­˜
    document.getElementById('user-name').addEventListener('change', (e) => {
      store.set('userName', e.target.value);
      showAlert('âœ… åå‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success', 'sync-alert');
    });

    async function loadHotkeys() {
      const mainHotkey = await ipcRenderer.invoke('get-current-hotkey', 'main');
      const snippetHotkey = await ipcRenderer.invoke('get-current-hotkey', 'snippet');
      
      document.getElementById('hotkey-main').value = mainHotkey || (isMac ? 'Command+Control+C' : 'Ctrl+Alt+C');
      document.getElementById('hotkey-snippet').value = snippetHotkey || (isMac ? 'Command+Control+V' : 'Ctrl+Alt+V');
    }

    async function loadSyncStatus() {
      const lastSync = store.get('lastSync');
      const statusDiv = document.getElementById('sync-status');
      
      if (lastSync) {
        const date = new Date(lastSync);
        statusDiv.textContent = `æœ€çµ‚åŒæœŸ: ${date.toLocaleString('ja-JP')}`;
      } else {
        statusDiv.textContent = 'æœ€çµ‚åŒæœŸ: æœªåŒæœŸ';
      }
    }

    function openExternal(url) {
      shell.openExternal(url);
    }

    function showHotkeyModal(type) {
      currentEditingType = type;
      capturedHotkey = null;
      
      const title = type === 'main' ? 'ç°¡æ˜“ãƒ›ãƒ¼ãƒ ã®ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’å¤‰æ›´' : 'ã‚¹ãƒ‹ãƒšãƒƒãƒˆå°‚ç”¨ã®ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’å¤‰æ›´';
      document.getElementById('modal-title').textContent = title;
      document.getElementById('hotkey-input').value = '';
      document.getElementById('hotkey-error').style.display = 'none';
      document.getElementById('save-hotkey-btn').disabled = true;
      document.getElementById('hotkey-modal').classList.add('show');
      
      setTimeout(() => {
        document.getElementById('hotkey-input').focus();
      }, 100);
    }

    function closeHotkeyModal() {
      document.getElementById('hotkey-modal').classList.remove('show');
      capturedHotkey = null;
      currentEditingType = null;
    }

    async function saveHotkey() {
      if (!capturedHotkey || !currentEditingType) return;
      
      const result = await ipcRenderer.invoke('set-hotkey', currentEditingType, capturedHotkey);
      
      if (result.success) {
        closeHotkeyModal();
        await loadHotkeys();
        showAlert('âœ… ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚', 'success', 'shortcut-alert');
      } else {
        document.getElementById('hotkey-error').textContent = `âŒ ${result.error}`;
        document.getElementById('hotkey-error').style.display = 'block';
      }
    }

    async function resetAllHotkeys() {
      if (!confirm('ã™ã¹ã¦ã®ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã™ã‹?')) return;
      
      await ipcRenderer.invoke('reset-all-hotkeys');
      await loadHotkeys();
      showAlert('âœ… ã™ã¹ã¦ã®ãƒ›ãƒƒãƒˆã‚­ãƒ¼ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã—ã¾ã—ãŸã€‚', 'success', 'shortcut-alert');
    }

    async function saveMasterUrl() {
      const url = document.getElementById('master-url').value.trim();
      if (!url) {
        showAlert('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error', 'sync-alert');
        return;
      }

      const result = await ipcRenderer.invoke('set-master-url', url);
      if (result.success) {
        showAlert('âœ… ãƒã‚¹ã‚¿ãƒ¼URLã‚’ä¿å­˜ã—ã€åŒæœŸã—ã¾ã—ãŸ', 'success', 'sync-alert');
        await loadSyncStatus();
        await loadFolders();
      } else {
        showAlert(`âŒ ${result.error || 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error', 'sync-alert');
      }
    }

    async function manualSync() {
      const result = await ipcRenderer.invoke('manual-sync');
      if (result.success) {
        showAlert('âœ… åŒæœŸå®Œäº†ã—ã¾ã—ãŸ', 'success', 'sync-alert');
        await loadSyncStatus();
        await loadFolders();
      } else {
        showAlert(`âŒ ${result.error || 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ'}`, 'error', 'sync-alert');
      }
    }

    function showAlert(message, type = 'info', elementId = 'sync-alert') {
      const alert = document.getElementById(elementId);
      alert.className = `alert alert-${type} show`;
      alert.textContent = message;
      
      // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯10ç§’ã€ãã‚Œä»¥å¤–ã¯5ç§’ã§æ¶ˆãˆã‚‹
      const duration = type === 'error' ? 10000 : 5000;
      
      setTimeout(() => {
        alert.classList.remove('show');
      }, duration);
    }

    async function loadFolders() {
      const data = await ipcRenderer.invoke('get-all-items');
      const masterSnippets = data.masterSnippets || [];
      
      // ãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®ãƒ•ã‚©ãƒ«ãƒ€
      const masterFolders = [...new Set(masterSnippets.map(s => s.folder || 'æœªåˆ†é¡'))];
      
      // å€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã®ãƒ•ã‚©ãƒ«ãƒ€
      const personalData = await ipcRenderer.invoke('get-personal-snippets');
      const personalFolders = personalData.folders || [];
      
      // ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’çµ±åˆï¼ˆé‡è¤‡æ’é™¤ï¼‰
      const allFolders = [...new Set([...masterFolders, ...personalFolders])];
      
      const hiddenFolders = store.get('hiddenFolders', []);
      
      const folderListDiv = document.getElementById('folder-list');
      
      if (allFolders.length === 0) {
        folderListDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #999; font-size: 12px;">ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      folderListDiv.innerHTML = allFolders.map(folder => {
        const isMaster = masterFolders.includes(folder);
        const isPersonal = personalFolders.includes(folder);
        
        let badge = '';
        if (isMaster && isPersonal) {
          badge = '<span style="font-size: 10px; padding: 2px 6px; background: #007aff; color: white; border-radius: 3px; margin-left: 6px;">ãƒã‚¹ã‚¿ãƒ»å€‹åˆ¥</span>';
        } else if (isMaster) {
          badge = '<span style="font-size: 10px; padding: 2px 6px; background: #34c759; color: white; border-radius: 3px; margin-left: 6px;">ãƒã‚¹ã‚¿</span>';
        } else if (isPersonal) {
          badge = '<span style="font-size: 10px; padding: 2px 6px; background: #ff9500; color: white; border-radius: 3px; margin-left: 6px;">å€‹åˆ¥</span>';
        }
        
        return `
        <div style="padding: 5px 8px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" 
                id="folder-${escapeAttr(folder)}" 
                value="${escapeAttr(folder)}" 
                ${!hiddenFolders.includes(folder) ? 'checked' : ''}
                style="width: 16px; height: 16px; cursor: pointer;">
          <label for="folder-${escapeAttr(folder)}" 
                style="flex: 1; cursor: pointer; font-size: 11px; color: #333; margin-bottom: 0; display: flex; align-items: center; line-height: 1.2;">
            ${escapeHtml(folder)}${badge}
          </label>
        </div>
      `;
      }).join('');
    }

    async function loadWindowPositionSetting() {
      const positionMode = store.get('windowPositionMode', 'cursor');
      
      const radioButtons = document.querySelectorAll('input[name="windowPosition"]');
      radioButtons.forEach(radio => {
        if (radio.value === positionMode) {
          radio.checked = true;
        }
      });
    }

    async function saveFolderSettings() {
      const checkboxes = document.querySelectorAll('#folder-list input[type="checkbox"]');
      const hiddenFolders = [];
      
      checkboxes.forEach(checkbox => {
        if (!checkbox.checked) {
          hiddenFolders.push(checkbox.value);
        }
      });
      
      store.set('hiddenFolders', hiddenFolders);
      showAlert(`âœ… ãƒ•ã‚©ãƒ«ãƒ€è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ${hiddenFolders.length}å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’éè¡¨ç¤ºï¼‰`, 'success', 'folder-alert');

      const selectedPosition = document.querySelector('input[name="windowPosition"]:checked');
      if (selectedPosition) {
        store.set('windowPositionMode', selectedPosition.value);
      }
    }

    function selectAllFolders() {
      const checkboxes = document.querySelectorAll('#folder-list input[type="checkbox"]');
      checkboxes.forEach(checkbox => checkbox.checked = true);
    }

    function deselectAllFolders() {
      const checkboxes = document.querySelectorAll('#folder-list input[type="checkbox"]');
      checkboxes.forEach(checkbox => checkbox.checked = false);
    }

    async function removeMasterUrl() {
      if (!confirm('Google DriveåŒæœŸã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nãƒã‚¹ã‚¿ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nå€‹åˆ¥ã‚¹ãƒ‹ãƒšãƒƒãƒˆã¯æ®‹ã‚Šã¾ã™ã€‚')) {
        return;
      }

      const result = await ipcRenderer.invoke('remove-master-url');
      if (result) {
        document.getElementById('master-url').value = '';
        showAlert('âœ… åŒæœŸã‚’è§£é™¤ã—ã¾ã—ãŸ', 'success', 'sync-alert');
        await loadSyncStatus();
        await loadFolders();
      } else {
        showAlert('âŒ åŒæœŸè§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error', 'sync-alert');
      }
    }
  </script>
</body>
</html>