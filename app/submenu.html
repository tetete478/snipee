<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Submenu</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', 'Hiragino Sans', sans-serif;
      background: #ffffff;
      color: #333;
      overflow: hidden;
      user-select: none;
      font-size: 14px;
    }

    .container {
      width: 280px;
      max-height: 400px;
      background: #ffffff;
      border-radius: 8px;
      overflow-y: auto;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      border: 1px solid #e0e0e0;
    }

    .menu-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      background: #ffffff;
      transition: background 0.1s;
    }

    .menu-item:hover {
      background: #f0f0f0;
    }

    .menu-item:last-child {
      border-bottom: none;
    }

    .menu-item.selected {
      background: #e7f3ff;
      border-left: 3px solid #667eea;
    }

    .menu-item-content {
      flex: 1;
      min-width: 0;
    }

    .menu-item-title {
      font-size: 13px;
      color: #333;
      font-weight: 500;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-item-preview {
      font-size: 11px;
      color: #999;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #f8f8f8;
    }

    ::-webkit-scrollbar-thumb {
      background: #d0d0d0;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #b0b0b0;
    }

    .empty-state {
      padding: 40px 20px;
      text-align: center;
      color: #999;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="container" id="submenu-container">
    <!-- 動的に生成 -->
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let items = [];
    let currentIndex = 0;

    // 初期化
    ipcRenderer.on('show-items', (event, data) => {
      items = data.items || [];
      render();
    });

    // レンダリング
    function render() {
      const container = document.getElementById('submenu-container');

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">アイテムがありません</div>';
        return;
      }

      container.innerHTML = items.map((item, index) => `
        <div class="menu-item">
          <div class="menu-item-content">
            <div class="menu-item-title">${escapeHtml(item.title || 'Untitled')}</div>
            <div class="menu-item-preview">${escapeHtml((item.content || '').substring(0, 40))}${(item.content || '').length > 40 ? '...' : ''}</div>
          </div>
        </div>
      `).join('');

      // 初期選択
      currentIndex = 0;
      updateSelection();
    }

    // 選択状態の更新
    function updateSelection() {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach((item, index) => {
        if (index === currentIndex) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // アイテム選択
    async function selectItem(index) {
      const item = items[index];
      if (item) {
        await ipcRenderer.invoke('select-submenu-item', item);
      }
    }

    // キーボード操作
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' || e.key === 'ArrowLeft') {
        e.preventDefault();
        ipcRenderer.invoke('hide-submenu');
        ipcRenderer.send('submenu-closed-by-user');
        return;
      }

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentIndex = Math.min(currentIndex + 1, items.length - 1);
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentIndex = Math.max(currentIndex - 1, 0);
        updateSelection();
      } else if (e.key === 'Enter') {
        e.preventDefault();
        selectItem(currentIndex);
      }
    });

    // HTMLエスケープ
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>